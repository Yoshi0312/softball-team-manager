<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ« ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç®¡ç†</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1 id="page-title">ãƒ›ãƒ¼ãƒ </h1>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button id="header-team-switch" onclick="switchTeam()" title="ãƒãƒ¼ãƒ åˆ‡æ›¿" style="font-size: 11px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; border-radius: 12px; padding: 2px 10px; cursor: pointer; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis;"></button>
            <span id="header-user-name" style="font-size: 12px; opacity: 0.8;"></span>
            <button class="header-btn" onclick="openSettings()" title="è¨­å®š">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <button class="header-btn" onclick="logout()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Home Page -->
    <div id="page-home" class="page active">
        <div class="card">
            <h2 class="card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-primary btn-block" onclick="showPage('lineup'); startNewLineup();">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¡¨ä½œæˆ
                </button>
                <button class="btn btn-secondary btn-block" onclick="showPage('saved')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    ä¿å­˜æ¸ˆã¿ã‚’é–‹ã
                </button>
                <button class="btn btn-secondary btn-block" onclick="showPage('attendance')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 7V3m8 4V3m-9 8h10"/>
                        <rect x="3" y="5" width="18" height="16" rx="2"/>
                    </svg>
                    å‡ºæ¬ ç®¡ç†ã‚’é–‹ã
                </button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ç™»éŒ²é¸æ‰‹</h2>
            <div id="home-player-summary">
                <p class="text-muted">é¸æ‰‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
            </div>
            <button class="btn btn-secondary btn-block mt-4" onclick="showPage('players')">
                é¸æ‰‹ä¸€è¦§ã‚’è¦‹ã‚‹
            </button>
        </div>


        <div class="card">
            <h2 class="card-title">å‡ºæ¬ çŠ¶æ³ï¼ˆæœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼‰</h2>
            <div id="home-attendance-summary">
                <p class="text-muted">ã‚¤ãƒ™ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
            <button class="btn btn-secondary btn-block mt-4" onclick="showPage('attendance')">
                å‡ºæ¬ ç®¡ç†ã‚’é–‹ã
            </button>
        </div>

        <div class="card">
            <h2 class="card-title">æœ€è¿‘ã®ãƒ¡ãƒ³ãƒãƒ¼è¡¨</h2>
            <div id="home-recent-lineups">
                <p class="text-muted">ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼è¡¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <!-- Players Page -->
    <div id="page-players" class="page">
        <div id="player-list-container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 class="card-title" style="margin: 0;">é¸æ‰‹ä¸€è¦§</h2>
                    <select id="player-sort" class="form-control" style="width: auto; padding: 8px 32px 8px 12px;" onchange="renderPlayerList()">
                        <option value="number">èƒŒç•ªå·é †</option>
                        <option value="name">åå‰é †</option>
                        <option value="position">ãƒã‚¸ã‚·ãƒ§ãƒ³é †</option>
                    </select>
                </div>
                <ul class="player-list" id="player-list">
                    <!-- Players will be rendered here -->
                </ul>
                <div id="player-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <p>ç™»éŒ²ã•ã‚ŒãŸé¸æ‰‹ãŒã„ã¾ã›ã‚“</p>
                    <button class="btn btn-primary mt-4" onclick="openPlayerModal()">é¸æ‰‹ã‚’ç™»éŒ²</button>
                </div>
            </div>
        </div>
        <button class="fab" onclick="openPlayerModal()" title="é¸æ‰‹ã‚’è¿½åŠ " data-role="admin">+</button>
    </div>

    <!-- Lineup Page -->
    <div id="page-lineup" class="page">
        <div class="card">
            <h2 class="card-title">è©¦åˆæƒ…å ±</h2>
            <div class="form-group">
                <label class="form-label">å¤§ä¼šå<span class="required">*</span></label>
                <input type="text" id="lineup-tournament" class="form-control" placeholder="ä¾‹: æ˜¥å­£å¤§ä¼š">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">è©¦åˆæ—¥<span class="required">*</span></label>
                    <input type="date" id="lineup-date" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">è‡ªãƒãƒ¼ãƒ </label>
                    <input type="text" id="lineup-team" class="form-control" placeholder="ãƒãƒ¼ãƒ å">
                </div>
                <div class="form-group">
                    <label class="form-label">ç›¸æ‰‹ãƒãƒ¼ãƒ </label>
                    <input type="text" id="lineup-opponent" class="form-control" placeholder="å¯¾æˆ¦ç›¸æ‰‹">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="lineup-use-dp" onchange="toggleDPRows()"> DPåˆ¶ã‚’ä½¿ç”¨
                </label>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ã‚¹ã‚¿ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¡ãƒ³ãƒãƒ¼</h2>
            <div style="overflow-x: auto;">
                <table class="lineup-table">
                    <thead>
                        <tr>
                            <th>æ‰“é †</th>
                            <th>å®ˆå‚™</th>
                            <th>é¸æ‰‹å</th>
                            <th>èƒŒç•ªå·</th>
                            <th>æ‰“</th>
                        </tr>
                    </thead>
                    <tbody id="lineup-starters">
                        <!-- Lineup rows will be rendered here -->
                    </tbody>
                </table>
            </div>
            <p class="text-muted mt-2" style="font-size: 12px;">
                é»„è‰²: å·¦æ‰“ / ç·‘: ä¸¡æ‰“ / â—: ãƒ¡ã‚¤ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ / â—‹: ã‚µãƒ–ãƒã‚¸ã‚·ãƒ§ãƒ³
            </p>
        </div>

        <div class="card">
            <h2 class="card-title">æ§ãˆé¸æ‰‹</h2>
            <div id="lineup-reserves">
                <!-- Reserve players will be rendered here -->
            </div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="addReserveSlot()">+ æ§ãˆé¸æ‰‹ã‚’è¿½åŠ </button>
        </div>

        <div class="card">
            <h2 class="card-title">ã‚¹ã‚¿ãƒƒãƒ•</h2>
            <div class="form-group">
                <label class="form-label">ç›£ç£</label>
                <input type="text" id="lineup-manager" class="form-control" placeholder="ç›£ç£å">
            </div>
            <div class="form-group">
                <label class="form-label">ã‚³ãƒ¼ãƒ</label>
                <input type="text" id="lineup-coach" class="form-control" placeholder="ã‚³ãƒ¼ãƒå">
            </div>
            <div class="form-group">
                <label class="form-label">ã‚¹ã‚³ã‚¢ãƒ©ãƒ¼</label>
                <input type="text" id="lineup-scorer" class="form-control" placeholder="ã‚¹ã‚³ã‚¢ãƒ©ãƒ¼å">
            </div>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="previewLineup()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="saveLineup()">ä¿å­˜</button>
        </div>
        <button class="btn btn-secondary btn-block" onclick="saveAsTemplate()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜</button>
    </div>

    <!-- Preview Page -->
    <div id="page-preview" class="page">
        <div class="tabs">
            <div class="tab active" onclick="switchPreviewTab('table')">ãƒ¡ãƒ³ãƒãƒ¼è¡¨</div>
            <div class="tab" onclick="switchPreviewTab('field')">å®ˆå‚™ä½ç½®å›³</div>
        </div>

        <div id="preview-table" class="card">
            <div class="preview-header">
                <div class="preview-title" id="preview-tournament"></div>
                <div id="preview-date"></div>
                <div class="preview-teams">
                    <span id="preview-team"></span>
                    <span>vs</span>
                    <span id="preview-opponent"></span>
                </div>
            </div>
            <table class="lineup-table" id="preview-lineup-table">
                <thead>
                    <tr>
                        <th>æ‰“é †</th>
                        <th>å®ˆå‚™</th>
                        <th>é¸æ‰‹å</th>
                        <th>èƒŒç•ªå·</th>
                    </tr>
                </thead>
                <tbody id="preview-lineup-body">
                </tbody>
            </table>
            <div class="mt-4">
                <h4 style="font-size: 14px; margin-bottom: 8px;">æ§ãˆé¸æ‰‹</h4>
                <div id="preview-reserves"></div>
            </div>
            <div class="mt-4">
                <p style="font-size: 13px;"><strong>ç›£ç£:</strong> <span id="preview-manager"></span></p>
                <p style="font-size: 13px;"><strong>ã‚³ãƒ¼ãƒ:</strong> <span id="preview-coach"></span></p>
            </div>
        </div>

        <div id="preview-field" class="card" style="display: none;">
            <div class="field-container">
                <svg class="field-svg" viewBox="0 0 400 400" id="field-svg">
                    <!-- Field background -->
                    <defs>
                        <linearGradient id="grass" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#4caf50"/>
                            <stop offset="100%" style="stop-color:#388e3c"/>
                        </linearGradient>
                        <linearGradient id="dirt" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#d7a86e"/>
                            <stop offset="100%" style="stop-color:#c49a6c"/>
                        </linearGradient>
                    </defs>

                    <!-- Outfield grass -->
                    <path d="M 200 380 L 20 200 A 250 250 0 0 1 380 200 Z" fill="url(#grass)"/>

                    <!-- Infield dirt -->
                    <path d="M 200 320 L 120 240 L 200 160 L 280 240 Z" fill="url(#dirt)"/>

                    <!-- Base paths -->
                    <line x1="200" y1="320" x2="120" y2="240" stroke="white" stroke-width="2"/>
                    <line x1="120" y1="240" x2="200" y2="160" stroke="white" stroke-width="2"/>
                    <line x1="200" y1="160" x2="280" y2="240" stroke="white" stroke-width="2"/>
                    <line x1="280" y1="240" x2="200" y2="320" stroke="white" stroke-width="2"/>

                    <!-- Bases -->
                    <rect x="192" y="312" width="16" height="16" fill="white" transform="rotate(45 200 320)"/>
                    <rect x="112" y="232" width="16" height="16" fill="white" transform="rotate(45 120 240)"/>
                    <rect x="192" y="152" width="16" height="16" fill="white" transform="rotate(45 200 160)"/>
                    <rect x="272" y="232" width="16" height="16" fill="white" transform="rotate(45 280 240)"/>

                    <!-- Pitcher's circle -->
                    <circle cx="200" cy="250" r="12" fill="url(#dirt)" stroke="white" stroke-width="1"/>

                    <!-- Player positions will be added dynamically -->
                    <g id="field-players"></g>
                </svg>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="showPage('lineup')">ç·¨é›†ã«æˆ»ã‚‹</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="downloadAsImage()">ç”»åƒã§ä¿å­˜</button>
        </div>
    </div>

    <!-- Saved Lineups Page -->
    <div id="page-saved" class="page">
        <div class="tabs">
            <div class="tab active" onclick="switchSavedTab('lineups')">ãƒ¡ãƒ³ãƒãƒ¼è¡¨</div>
            <div class="tab" onclick="switchSavedTab('templates')">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
        </div>

        <div id="saved-lineups" class="card">
            <div id="saved-lineups-list">
                <!-- Saved lineups will be rendered here -->
            </div>
            <div id="saved-lineups-empty" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <p>ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼è¡¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="saved-templates" class="card" style="display: none;">
            <div id="saved-templates-list">
                <!-- Templates will be rendered here -->
            </div>
            <div id="saved-templates-empty" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>


    <!-- Attendance Page -->
    <div id="page-attendance" class="page">
        <div class="card" data-role="admin">
            <h2 class="card-title">ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»ç·¨é›†</h2>
            <div style="display:grid; gap:8px;">
                <input id="attendance-title" class="form-control" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹: 3/10 ç·´ç¿’ï¼‰">
                <input id="attendance-date" class="form-control" type="date">
                <input id="attendance-note" class="form-control" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">
                <div style="display:flex; gap:8px;">
                    <button id="attendance-save-btn" class="btn btn-primary" onclick="saveAttendanceEvent()">ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</button>
                    <button class="btn btn-secondary" onclick="resetAttendanceEventForm()">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
            <div id="attendance-event-list"></div>
        </div>

        <div class="card">
            <h2 class="card-title">ã‚ãªãŸã®å›ç­”</h2>
            <div id="attendance-response"></div>
        </div>

        <div class="card">
            <h2 class="card-title">å›ç­”é›†è¨ˆ</h2>
            <div id="attendance-summary"></div>
        </div>
    </div>

    <!-- Stats Page -->
    <div id="page-stats" class="page">
        <div class="tabs">
            <div class="tab active" onclick="switchStatsTab('games')">è©¦åˆæˆç¸¾</div>
            <div class="tab" onclick="switchStatsTab('players')">é¸æ‰‹åˆ¥çµ±è¨ˆ</div>
        </div>

        <!-- Year Selector -->
        <div class="card" style="padding: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <label style="font-weight: 500;">å¹´åº¦:</label>
                <select id="stats-year" class="form-control" style="width: auto; flex: 1;" onchange="changeStatsYear(this.value)">
                </select>
                <label style="font-weight: 500;">ç¨®åˆ¥:</label>
                <select id="stats-game-type" class="form-control" style="width: auto; flex: 1;" onchange="changeStatsGameType(this.value)">
                    <option value="all">å…¨ã¦</option>
                    <option value="official">å…¬å¼æˆ¦ï¼ˆä¸€èˆ¬ï¼‰</option>
                    <option value="official_senior">å…¬å¼æˆ¦ï¼ˆå£®å¹´ï¼‰</option>
                    <option value="practice">ç·´ç¿’è©¦åˆ</option>
                    <option value="intrasquad">ç´…ç™½æˆ¦</option>
                </select>
            </div>
        </div>

        <!-- Team Summary -->
        <div id="team-summary-container"></div>
        <div id="team-trends-container"></div>

        <!-- Games List -->
        <div id="stats-games">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 class="card-title" style="margin: 0;">è©¦åˆä¸€è¦§</h2>
                    <button class="btn btn-primary btn-sm" onclick="openLineupSelectModal()" data-role="admin">+ æˆç¸¾å…¥åŠ›</button>
                </div>
                <div id="game-stats-list">
                    <!-- Game stats will be rendered here -->
                </div>
                <div id="game-stats-empty" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <p>æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <p class="text-muted mt-2" style="font-size: 13px;">ã€Œä¿å­˜æ¸ˆã¿ã€ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼è¡¨ã‚’é¸ã‚“ã§<br>æˆç¸¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <button class="btn btn-primary mt-4" onclick="openLineupSelectModal()">ãƒ¡ãƒ³ãƒãƒ¼è¡¨ã‹ã‚‰å…¥åŠ›</button>
                </div>
            </div>
        </div>

        <!-- Player Stats -->
        <div id="stats-players" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2 class="card-title" style="margin: 0;">æ‰“æ’ƒæˆç¸¾ä¸€è¦§</h2>
                    <select class="form-control" style="width: auto; padding: 4px 24px 4px 8px; font-size: 11px;" onchange="changeStatsSortBy(this.value)">
                        <option value="woba">wOBAé †</option>
                        <option value="avg">æ‰“ç‡é †</option>
                        <option value="ops">OPSé †</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="stats-table" id="player-stats-table">
                        <thead>
                            <tr>
                                <th>é¸æ‰‹</th>
                                <th>è©¦</th>
                                <th>æ‰“æ•°</th>
                                <th>å®‰æ‰“</th>
                                <th>æ‰“ç‡</th>
                                <th>å‡ºå¡</th>
                                <th>é•·æ‰“</th>
                                <th>OPS</th>
                                <th>wOBA</th>
                            </tr>
                        </thead>
                        <tbody id="player-stats-body">
                        </tbody>
                    </table>
                </div>
                <p class="text-muted mt-2" style="font-size: 11px;">
                    è©¦=è©¦åˆæ•° / å‡ºå¡=å‡ºå¡ç‡ / é•·æ‰“=é•·æ‰“ç‡ / wOBA=é‡ã¿ä»˜ã‘å‡ºå¡ç‡
                </p>
            </div>

            <div id="player-compare-container"></div>

            <div class="card">
                <h2 class="card-title">è©³ç´°æˆç¸¾</h2>
                <div style="overflow-x: auto;">
                    <table class="stats-table" id="player-detail-table">
                        <thead>
                            <tr>
                                <th>é¸æ‰‹</th>
                                <th>2å¡æ‰“</th>
                                <th>3å¡æ‰“</th>
                                <th>æœ¬å¡æ‰“</th>
                                <th>æ‰“ç‚¹</th>
                                <th>å››çƒ</th>
                                <th>ä¸‰æŒ¯</th>
                                <th>çŠ æ‰“</th>
                                <th>ISO</th>
                                <th>BABIP</th>
                                <th>K%</th>
                                <th>BB%</th>
                            </tr>
                        </thead>
                        <tbody id="player-detail-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Stat Modal -->
    <div id="game-stat-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px; max-height: 95vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="game-stat-modal-title">æˆç¸¾å…¥åŠ›</h3>
                <button class="modal-close" onclick="closeGameStatModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: calc(95vh - 130px); overflow-y: auto;">
                <input type="hidden" id="game-stat-edit-id">

                <!-- è©¦åˆæƒ…å ± -->
                <div class="card" style="margin-bottom: 12px; padding: 12px; background: var(--gray-light);">
                    <h4 style="font-size: 14px; margin-bottom: 12px;">è©¦åˆæƒ…å ±</h4>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">è©¦åˆæ—¥<span class="required">*</span></label>
                            <input type="date" id="game-stat-date" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">è©¦åˆç¨®åˆ¥</label>
                            <select id="game-stat-game-type" class="form-control">
                                <option value="official">å…¬å¼æˆ¦ï¼ˆä¸€èˆ¬ï¼‰</option>
                                <option value="official_senior">å…¬å¼æˆ¦ï¼ˆå£®å¹´ï¼‰</option>
                                <option value="practice">ç·´ç¿’è©¦åˆ</option>
                                <option value="intrasquad">ç´…ç™½æˆ¦</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">å…ˆæ”»/å¾Œæ”»</label>
                            <select id="game-stat-batting-order" class="form-control" onchange="updateBattingOrder(this.value); renderInningScoreTable();">
                                <option value="home">å¾Œæ”»ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰</option>
                                <option value="away">å…ˆæ”»ï¼ˆãƒ“ã‚¸ã‚¿ãƒ¼ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">å¤§ä¼šå</label>
                            <input type="text" id="game-stat-tournament" class="form-control" placeholder="ä¾‹: æ˜¥å­£å¤§ä¼š">
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">ç›¸æ‰‹ãƒãƒ¼ãƒ </label>
                            <input type="text" id="game-stat-opponent" class="form-control" placeholder="å¯¾æˆ¦ç›¸æ‰‹">
                        </div>
                    </div>
                </div>

                <!-- ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ -->
                <div class="card" style="margin-bottom: 12px; padding: 12px; background: var(--gray-light);">
                    <h4 style="font-size: 14px; margin-bottom: 12px;">ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢</h4>
                    <div style="overflow-x: auto;">
                        <table class="inning-score-table" style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="width: 60px; padding: 4px; border: 1px solid var(--border);"></th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">1</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">2</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">3</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">4</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">5</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">6</th>
                                    <th style="padding: 4px; border: 1px solid var(--border);">7</th>
                                    <th style="width: 40px; padding: 4px; border: 1px solid var(--border); font-weight: 600;">è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody id="inning-score-tbody">
                                <!-- Dynamic content rendered by renderInningScoreTable() -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- æŠ•æ‰‹æˆç¸¾ -->
                <div class="card" style="margin-bottom: 12px; padding: 12px; background: var(--gray-light);">
                    <h4 style="font-size: 14px; margin-bottom: 12px;">æŠ•æ‰‹æˆç¸¾</h4>
                    <div id="pitcher-stats-inputs">
                        <!-- Pitcher inputs will be rendered here -->
                    </div>
                    <button class="btn btn-secondary btn-sm mt-2" onclick="addPitcherEntry()">+ æŠ•æ‰‹ã‚’è¿½åŠ </button>
                </div>

                <!-- æ‰“æ’ƒæˆç¸¾ -->
                <h4 style="margin: 16px 0 12px; font-size: 15px;">æ‰“æ’ƒæˆç¸¾</h4>
                <p style="font-size: 11px; color: var(--gray); margin-bottom: 8px;">å¾—ç‚¹=å¾—ç‚¹ / ç›—=ç›—å¡</p>
                <div id="player-batting-inputs">
                    <!-- Player batting inputs will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGameStatModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" id="game-stat-delete-btn" style="display: none;" onclick="deleteGameStat()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveGameStat()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Player Stat Detail Modal -->
    <div id="player-stat-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="player-stat-modal-title">é¸æ‰‹æˆç¸¾è©³ç´°</h3>
                <button class="modal-close" onclick="closePlayerStatModal()">&times;</button>
            </div>
            <div class="modal-body" id="player-stat-modal-body">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closePlayerStatModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Lineup Select Modal -->
    <div id="lineup-select-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ãƒ¡ãƒ³ãƒãƒ¼è¡¨ã‚’é¸æŠ</h3>
                <button class="modal-close" onclick="closeLineupSelectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4" style="font-size: 13px;">æˆç¸¾ã‚’å…¥åŠ›ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼è¡¨ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div id="lineup-select-list">
                    <!-- Lineup list will be rendered here -->
                </div>
                <div id="lineup-select-empty" class="empty-state" style="padding: 20px;">
                    <p>ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼è¡¨ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <button class="btn btn-secondary mt-2" onclick="closeLineupSelectModal(); showPage('lineup');">ãƒ¡ãƒ³ãƒãƒ¼è¡¨ã‚’ä½œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page">
        <div class="card">
            <h2 class="card-title">ãƒãƒ¼ãƒ è¨­å®š</h2>
            <div class="form-group">
                <label class="form-label">ãƒãƒ¼ãƒ å</label>
                <input type="text" id="settings-team-name" class="form-control" placeholder="ãƒãƒ¼ãƒ åã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label class="form-label">ç›£ç£åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label>
                <input type="text" id="settings-manager" class="form-control" placeholder="ç›£ç£å">
            </div>
            <div class="form-group">
                <label class="form-label">ã‚³ãƒ¼ãƒåï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label>
                <input type="text" id="settings-coach" class="form-control" placeholder="ã‚³ãƒ¼ãƒå">
            </div>
            <button class="btn btn-primary btn-block" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
        </div>


        <div class="card" id="invite-admin-card" data-role="admin">
            <h2 class="card-title">æ‹›å¾…ãƒªãƒ³ã‚¯ç®¡ç†</h2>
            <p class="text-muted" style="font-size: 12px; margin-bottom: 12px;">URLå…±æœ‰ã‚’ä¸»å°ç·šã«ã—ã¤ã¤ã€æ‰‹å…¥åŠ›ã‚³ãƒ¼ãƒ‰å‚åŠ ã‚‚ç¶™ç¶šåˆ©ç”¨ã§ãã¾ã™ã€‚</p>
            <button class="btn btn-primary btn-block" onclick="createInviteLinkFromAdmin()">æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œ</button>
            <div class="form-group" style="margin-top: 12px;">
                <label class="form-label">æœ€æ–°ã®æ‹›å¾…URL</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="invite-latest-url" class="form-control" placeholder="ç™ºè¡Œã™ã‚‹ã¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™" readonly>
                    <button class="btn btn-secondary" style="flex:0 0 auto;" onclick="copyInviteFromLatestField()">ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
            <div style="overflow:auto;">
                <table class="stats-table" style="font-size: 12px; min-width: 720px;">
                    <thead>
                        <tr>
                            <th>ã‚³ãƒ¼ãƒ‰ / URL</th>
                            <th>çŠ¶æ…‹</th>
                            <th>æœ‰åŠ¹æœŸé™</th>
                            <th>ä½¿ç”¨è€…</th>
                            <th>ä½¿ç”¨æ—¥æ™‚</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="invite-list-body"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <button class="btn btn-secondary btn-block mb-2" onclick="exportData()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸Šæ›¸ããƒ»å…¨å‰Šé™¤ã®å‰ã«ã€å¿…ãšã€Œãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="btn btn-secondary btn-block mb-2" onclick="document.getElementById('import-file').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn btn-danger btn-block" onclick="confirmClearData()" data-role="admin">
                å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
        </div>

        <div class="card">
            <h2 class="card-title">ã‚¢ãƒ—ãƒªæƒ…å ±</h2>
            <p style="font-size: 14px; color: var(--gray);">
                ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ« ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç®¡ç†<br>
                ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.0.0
            </p>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="player-modal-title">é¸æ‰‹ç™»éŒ²</h3>
                <button class="modal-close" onclick="closePlayerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="player-edit-id">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é¸æ‰‹å<span class="required">*</span></label>
                        <input type="text" id="player-name" class="form-control" placeholder="å±±ç”° å¤ªéƒ">
                    </div>
                    <div class="form-group" style="flex: 0 0 80px;">
                        <label class="form-label">èƒŒç•ªå·<span class="required">*</span></label>
                        <input type="number" id="player-number" class="form-control" min="0" max="99" placeholder="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æ‰“å¸­<span class="required">*</span></label>
                        <select id="player-batting" class="form-control">
                            <option value="right">å³æ‰“</option>
                            <option value="left">å·¦æ‰“</option>
                            <option value="switch">ä¸¡æ‰“</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æŠ•ã’<span class="required">*</span></label>
                        <select id="player-throwing" class="form-control">
                            <option value="right">å³æŠ•</option>
                            <option value="left">å·¦æŠ•</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ã‚¤ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³<span class="required">*</span></label>
                    <select id="player-main-position" class="form-control">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="1">1: æŠ•æ‰‹(P)</option>
                        <option value="2">2: æ•æ‰‹(C)</option>
                        <option value="3">3: ä¸€å¡æ‰‹(1B)</option>
                        <option value="4">4: äºŒå¡æ‰‹(2B)</option>
                        <option value="5">5: ä¸‰å¡æ‰‹(3B)</option>
                        <option value="6">6: éŠæ’ƒæ‰‹(SS)</option>
                        <option value="7">7: å·¦ç¿¼æ‰‹(LF)</option>
                        <option value="8">8: ä¸­å …æ‰‹(CF)</option>
                        <option value="9">9: å³ç¿¼æ‰‹(RF)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚µãƒ–ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                    <div class="checkbox-group" id="player-sub-positions">
                        <label class="checkbox-item"><input type="checkbox" value="1"> P</label>
                        <label class="checkbox-item"><input type="checkbox" value="2"> C</label>
                        <label class="checkbox-item"><input type="checkbox" value="3"> 1B</label>
                        <label class="checkbox-item"><input type="checkbox" value="4"> 2B</label>
                        <label class="checkbox-item"><input type="checkbox" value="5"> 3B</label>
                        <label class="checkbox-item"><input type="checkbox" value="6"> SS</label>
                        <label class="checkbox-item"><input type="checkbox" value="7"> LF</label>
                        <label class="checkbox-item"><input type="checkbox" value="8"> CF</label>
                        <label class="checkbox-item"><input type="checkbox" value="9"> RF</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å­¦å¹´/å¹´é½¢</label>
                    <input type="text" id="player-grade" class="form-control" placeholder="ä¾‹: 3å¹´">
                </div>
                <div class="form-group">
                    <label class="form-label">å‚™è€ƒ</label>
                    <textarea id="player-note" class="form-control" rows="2" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ç™»éŒ²çŠ¶æ…‹</label>
                    <select id="player-status" class="form-control">
                        <option value="active">æœ‰åŠ¹</option>
                        <option value="ä¼‘éƒ¨">ä¼‘éƒ¨</option>
                        <option value="é€€éƒ¨">é€€éƒ¨</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlayerModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" id="player-delete-btn" style="display: none;" onclick="deletePlayer()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="savePlayer()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal" style="max-width: 340px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-title">ç¢ºèª</h3>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" id="confirm-btn" onclick="confirmAction()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a class="nav-item active" onclick="showPage('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            ãƒ›ãƒ¼ãƒ 
        </a>
        <a class="nav-item" onclick="showPage('players')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
            é¸æ‰‹
        </a>
        <a class="nav-item" onclick="showPage('lineup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
            ä½œæˆ
        </a>
        <a class="nav-item" onclick="showPage('attendance')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            å‡ºæ¬ 
        </a>
        <a class="nav-item" onclick="showPage('stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            æˆç¸¾
        </a>
        <a class="nav-item" onclick="showPage('saved')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
            </svg>
            ä¿å­˜
        </a>
    </nav>

    <!-- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ & ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ -->
    <!-- LocalStorageç§»è¡ŒãƒãƒŠãƒ¼ -->
    <div id="migration-banner" style="display:none; position:fixed; top:0; left:0; right:0; z-index:9999; background:#fff3cd; border-bottom:2px solid #ffc107; padding:12px 16px;">
        <div style="max-width:600px; margin:0 auto;">
            <p style="margin:0 0 8px; font-weight:bold; color:#856404;">ğŸ“¦ æ—§ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ</p>
            <p id="migration-summary" style="margin:0 0 12px; font-size:13px; color:#856404;"></p>
            <div style="display:flex; gap:8px;">
                <button id="migration-start-btn" onclick="startMigration()" style="padding:8px 20px; background:#1a73e8; color:white; border:none; border-radius:4px; cursor:pointer; font-size:14px;">ç§»è¡Œã™ã‚‹</button>
                <button onclick="dismissMigration()" style="padding:8px 20px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-size:14px;">ã‚¹ã‚­ãƒƒãƒ—</button>
            </div>
        </div>
    </div>

    <script type="module">
        import './js/firebase-init.js';
        import { auth } from './js/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
        import * as authModule from './js/auth.js';
        import * as appModule from './js/app.js';
        import { hasLocalStorageData, isMigrated, getLocalStorageSummary, migrateLocalStorageToFirestore } from './js/migration.js';

        // ES Modules ã®é–¢æ•°ã‚’ window ã«å…¬é–‹ï¼ˆinline onclick ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
        Object.assign(window, appModule, authModule);

        window.copyInviteFromLatestField = function() {
            const value = document.getElementById('invite-latest-url').value.trim();
            if (!value) {
                alert('å…ˆã«æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            try {
                const code = new URL(value).searchParams.get('invite');
                if (!code) {
                    alert('æ‹›å¾…URLãŒä¸æ­£ã§ã™');
                    return;
                }
                window.copyInviteLink(code);
            } catch (e) {
                alert('æ‹›å¾…URLãŒä¸æ­£ã§ã™');
            }
        };

        // ç§»è¡ŒãƒãƒŠãƒ¼ã®æ“ä½œã‚’windowã«å…¬é–‹
        let _currentTeamId = null;

        window.startMigration = async function() {
            const btn = document.getElementById('migration-start-btn');
            btn.disabled = true;
            btn.textContent = 'ç§»è¡Œä¸­...';
            try {
                const result = await migrateLocalStorageToFirestore(_currentTeamId);
                if (result.migrated) {
                    alert(`ç§»è¡Œå®Œäº†ï¼\né¸æ‰‹: ${result.counts.players}ä»¶\nãƒ¡ãƒ³ãƒãƒ¼è¡¨: ${result.counts.lineups}ä»¶\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ${result.counts.templates}ä»¶\nè©¦åˆæˆç¸¾: ${result.counts.gameStats}ä»¶`);
                    document.getElementById('migration-banner').style.display = 'none';
                    // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                    await appModule.loadData();
                    appModule.updateHomePage();
                } else {
                    alert('ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || result.reason));
                    btn.disabled = false;
                    btn.textContent = 'ç§»è¡Œã™ã‚‹';
                }
            } catch (e) {
                alert('ç§»è¡Œã‚¨ãƒ©ãƒ¼: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'ç§»è¡Œã™ã‚‹';
            }
        };

        window.dismissMigration = function() {
            document.getElementById('migration-banner').style.display = 'none';
        };

        // ãƒãƒ¼ãƒ åˆ‡æ›¿: login.htmlã®ãƒãƒ¼ãƒ é¸æŠç”»é¢ã«é·ç§»
        window.switchTeam = function() {
            localStorage.removeItem('selectedTeamId');
            // ãƒãƒ¼ãƒ ãŒ1ã¤ã§ã‚‚è‡ªå‹•å†é¸æŠã•ã‚Œãªã„ã‚ˆã†ã«ã€æ˜ç¤ºçš„ã«é¸æŠç”»é¢ã‚’è¦æ±‚
            localStorage.setItem('forceTeamSelect', '1');
            window.location.href = '/login.html';
        };

        // ãƒ‡ãƒãƒƒã‚°: index.html ã® inline onclick ã§ä½¿ã†é–¢æ•°ãŒ window ã§è§£æ±ºã§ãã‚‹ã‹ç¢ºèª
        const _required = [
            'showPage', 'openSettings', 'switchTeam', 'logout',
            'renderAttendancePage', 'selectAttendanceEvent', 'saveMyAttendance',
            'editAttendanceEvent', 'resetAttendanceEventForm', 'saveAttendanceEvent',
            'startMigration', 'dismissMigration',
            'renderPlayerList', 'openPlayerModal', 'closePlayerModal', 'savePlayer', 'deletePlayer',
            'startNewLineup', 'toggleDPRows', 'updateStarterPosition', 'updateStarterPlayer',
            'updateReserve', 'addReserveSlot', 'saveLineup', 'saveAsTemplate',
            'loadLineup', 'deleteLineup', 'previewLineup', 'switchPreviewTab',
            'downloadAsImage', 'switchSavedTab', 'switchStatsTab',
            'changeStatsYear', 'changeStatsGameType', 'changeStatsSortBy',
            'openLineupSelectModal', 'closeLineupSelectModal',
            'openGameStatFromLineup', 'openGameStatModal',
            'updateBattingOrder', 'renderInningScoreTable',
            'updateAtBat', 'updatePlayerStat', 'calcTotalScore',
            'updatePitcherStat', 'addPitcherEntry', 'removePitcherEntry',
            'closeGameStatModal', 'saveGameStat', 'deleteGameStatConfirm', 'deleteGameStat',
            'showPlayerStatDetail', 'closePlayerStatModal',
            'closeConfirmModal', 'confirmAction',
            'saveSettings', 'exportData', 'importData', 'confirmClearData',
            'createInviteLinkFromAdmin', 'copyInviteLink', 'reissueInviteFromAdmin', 'invalidateInviteFromAdmin',
            'copyInviteFromLatestField'
        ];
        const _miss = _required.filter(fn => typeof window[fn] !== 'function');
        if (_miss.length) console.error('æœªç™»éŒ²é–¢æ•°:', _miss);
        else console.log('âœ“ å…¨onclické–¢æ•°ãŒwindowã«ç™»éŒ²æ¸ˆã¿ (' + _required.length + 'å€‹)');

        // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ â†’ æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰login.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            // é¸æŠä¸­ã®ãƒãƒ¼ãƒ IDã‚’å–å¾—
            const teamId = localStorage.getItem('selectedTeamId');
            if (!teamId) {
                window.location.href = '/login.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ¼ãƒ å†…ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèª
            const role = await authModule.getUserRole(teamId, user.uid);
            if (!role) {
                localStorage.removeItem('selectedTeamId');
                window.location.href = '/login.html';
                return;
            }

            // ãƒãƒ¼ãƒ ãƒ»ãƒ­ãƒ¼ãƒ«è¨­å®š & UIåˆ¶å¾¡
            authModule.setCurrentTeam(teamId, role);
            authModule.updateUIForRole(role);
            document.getElementById('header-user-name').textContent = user.displayName || '';

            // ãƒãƒ¼ãƒ åã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
            const teams = await authModule.getUserTeams(user.uid);
            const currentTeam = teams.find(t => t.teamId === teamId);
            if (currentTeam) {
                document.getElementById('header-team-switch').textContent = currentTeam.teamName;
            }

            // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ï¼ˆFirestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼‰
            _currentTeamId = teamId;
            await appModule.init(teamId);

            // LocalStorageç§»è¡ŒãƒãƒŠãƒ¼è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
            if (hasLocalStorageData() && !isMigrated()) {
                const summary = getLocalStorageSummary();
                if (summary) {
                    const parts = [];
                    if (summary.players > 0) parts.push(`é¸æ‰‹ ${summary.players}ä»¶`);
                    if (summary.lineups > 0) parts.push(`ãƒ¡ãƒ³ãƒãƒ¼è¡¨ ${summary.lineups}ä»¶`);
                    if (summary.templates > 0) parts.push(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${summary.templates}ä»¶`);
                    if (summary.gameStats > 0) parts.push(`è©¦åˆæˆç¸¾ ${summary.gameStats}ä»¶`);
                    document.getElementById('migration-summary').textContent =
                        `æ—§ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆ${parts.join('ã€')}ï¼‰ã€‚Firestoreã«ç§»è¡Œã—ã¾ã™ã‹ï¼Ÿ`;
                    document.getElementById('migration-banner').style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>
